import tkinter as tk
from PyTick.models import Task

class AppGUI:
    def __init__(self,master):
        self.master = master
        self.tasks = []
        self.timer_display_var = tk.StringVar(value="00d 00h 00m 00s")
        self.title_var = tk.StringVar()
        self.date_var = tk.StringVar("YYYY-MM-DD")
        self.time_var = tk.StringVar("HH:MM")
        
        self.timer_label = tk.Label(
            self.master,
            textvariable=self.timer_display_var,
            font=("Arial", 40, "bold"),
            bg="#2C3E50",
            fg="#ECF0F1"
        )
        self.timer_label.pack(pady=20, padx=10, fill=tk.X)
        self.setup_input_widgets()
        self.update_timer()
        
        def add_task(self):
            task_title = self.title_var.get().strip()
            date_str = self.date_var.get().strip()
            time_str = self.time_var.get().strip()
            
            if not task_title: 
                print("Error: Task title cannot be emptry")
                return
            deadline_dt = parse_deadline_str(date_str, time_str)

            if deadline_dt is None: 
                print(f"Error: Invalid date or time format entered: {date_str}, {time_str}")
                return
            
            new_task = Task(title=task_title, deadline=deadline_dt)
            self.tasks.append(new_task)
            
            self.title_var.set("")
            
            
            print(f"Task added: {new_task.title} - Due: {new_task.deadline}")        
            

    def get_closest_task(self):
        active_tasks = [t for t in self.tasks if not getattr(t, 'completed', False)]
        if not active_tasks:
            return None
        
        active_tasks.sort(key=lambda task: task.deadline) 
        return active_tasks[0]

    def update_timer(self):

        closest_task = self.get_closest_task()
        if closest_task:
            from PyTick.models import get_time_remaining, format_timedelta 
            time_remaining_td = get_time_remaining(closest_task.deadline)
            formatted_time = format_timedelta(time_remaining_td)
            self.timer_display_var.set(formatted_time)
            
            if time_remaining_td.total_seconds() <= 0:
                self.timer_label.config(bg="red")
            else:
                self.timer_label.config(bg="#2C3E50")
        else:
      
            self.timer_display_var.set("No Tasks Active")
            self.timer_label.config(bg="#3498DB") 
            
        self.master.after(1000, self.update_timer)
        